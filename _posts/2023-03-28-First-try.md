---
layout: article
title: RGS Data processing
tags: Astronomy
tags: X-ray
aside:
    toc: true
mode: immersive
header:
  theme: dark
article_header:
  type: overlay
  theme: dark
  background_color: '#203028'
  background_image:
    gradient: 'linear-gradient(135deg, rgba(34, 139, 87 , .4), rgba(139, 34, 139, .4))'
    src: cover3.jpg
---

This is a detailed document about extracting spectrum from RGS data.

<!--more-->

# Flow Diagram

<img src="https://raw.githubusercontent.com/LittleCaps/LittleCaps.github.io/master/screenshots/ODF_2.png" alt="ODF_2" style="zoom:40%;" />

# Steps

## Data Preparing

```bash
export analysisdir=`pwd`
export SAS_ODF=$analysisdir

export DYLD_LIBRARY_PATH=$SAS_DIR/lib:$SAS_DIR/libextra
cifbuild
export SAS_CCF="$analysisdir/ccf.cif"
odfingest
export SAS_ODF="$analysisdir/`ls *.SAS`"
```

Remember to put the ASC, ATS and TCS files in the same folder with other files.

## Run the Pipeline

The reference point was set to the location of NGC 7319.

```bash
rgsproc orders='1' withmlambdacolumn=yes spectrumbinning=lambda bkgcorrect=no withbackgroundmodel=yes withsrc=yes srclabel=USER srcstyle=radec srcra=339.015 srcdec=33.9758667 xpsfincl=98
```

XMM_ABC_GUIDE recommends renaming files to some easy to type.

```bash
ln -s *R1*EVENLI*FIT r1_evt1.fits
ln -s *R2*EVENLI*FIT r2_evt1.fits
```

Here I used the **cp** command to copy the whole file for follow-up processing.

```bash
cp *R1*EVENLI*FIT r1_evt1.fits
cp *R2*EVENLI*FIT r2_evt1.fits

cp *R1*SRCLI*FIT r1_src.fits
cp *R2*SRCLI*FIT r2_src.fits

cp *R1*EXPMAP*.FIT r1_exp.fits
cp *R2*EXPMAP*.FIT r2_exp.fits
```

## Create an Image

```bash
evselect table='r1_evt1.fits:EVENTS' imageset='my_spatial.fit' xcolumn='M_LAMBDA' ycolumn='XDSP_CORR' 
evselect table='r1_evt1.fits:EVENTS' imageset='my_pi.fit' xcolumn='M_LAMBDA' ycolumn='PI' yimagemin=0 yimagemax=3000 expression='REGION(r1_src.fits:RGS1_S    RC3_SPATIAL,M_LAMBDA,XDSP_CORR)'
rgsimplot endispset='my_pi.fit' spatialset='my_spatial.fit' srcidlist='3' srclistset='r1_src.fits' device=/CPS plotfile=rgs1.ps
```

Be careful that the part "RGS1_SRC1_SPATIAL" will turn to "RGS1_SRC3_SPATIAL" and srcidlist should be set to "3" if you define source coordinates while extracting spectrum.

![rgs1](https://raw.githubusercontent.com/LittleCaps/LittleCaps.github.io/master/screenshots/rgs1.png)

## Create Light Curve

```bash
evselect table=r1_evt1.fits:EVENTS withrateset=yes rateset=ltcrv.fits maketimecolumn=yes timebinsize=100 makeratecolumn=yes expression='(CCDNR==9)&&(REGION(r1_src.fits:RGS1_BACKGROUND,M_LAMBDA,XDSP_CORR))'
```

<img src="https://raw.githubusercontent.com/LittleCaps/LittleCaps.github.io/master/screenshots/ltcrv1.png" alt="ltcrv" style="zoom:80%;" />

There are loud sections in the observation. To remove it, we need to make an additional Good Time Interval (GTI) file and apply it by rerunning rgsproc.

## Create GTI File

We remove loud parts in the observation.

```bash
tabgtigen table=ltcrv.fits gtiset=gti.fits expression='(RATE<0.1)'
```

### ReRun the Pipeline

Put the gti file while running the **rgsproc**.

```bash
rgsproc orders='1' withmlambdacolumn=yes spectrumbinning=lambda bkgcorrect=no withbackgroundmodel=yes withsrc=yes srclabel=USER srcstyle=radec srcra=339.015 srcdec=33.9758667 xpsfincl=98 auxgtitables=gti.fits
```

Here we get some new files generated by the pipeline with the git file.

## Create RMFs

The source coordinates have a profound influence on the accuracy of the wavelength scale as recorded in the RMF that is produced automatically by **rgsproc**, and each RGS instrument and each order will have its own RMF.

```bash
rgsrmfgen spectrumset='P0021140201R1S004SRSPEC1003.FIT' rmfset=r1_rmf.fits evlist=r1_evt1.fits
rgsrmfgen spectrumset='P0021140201R2S005SRSPEC1003.FIT' rmfset=r2_rmf.fits evlist=r2_evt1.fits
```

We get the rmf files repectively for rgs1 and rgs2.

## Combine Spectra

```bash
rgscombine pha='P0021140201R1S004SRSPEC1003.FIT P0021140201R2S005SRSPEC1003.FIT' rmf='P0021140201R1S004RSPMAT1003.FIT P0021140201R2S005RSPMAT1003.FIT' bkg='P0021140201R1S004MBSPEC1000.FIT P0021140201R2S005MBSPEC1000.FIT' filepha=all_pha.fits filermf=all_rmf.fits filebkg=all_mbg.fits min=6 max=38
```

# Script

```bash
shopt -s expand_aliases
source ~/.bashrc
heainit
sasinit

export analysisdir=`pwd`
export SAS_ODF=$analysisdir
echo $SAS_ODF

export DYLD_LIBRARY_PATH=$SAS_DIR/lib:$SAS_DIR/libextra
cifbuild
export SAS_CCF="$analysisdir/ccf.cif"
odfingest
export SAS_ODF="$analysisdir/`ls *.SAS`"

#run the pipeline
rgsproc orders='1' withmlambdacolumn=yes spectrumbinning=lambda bkgcorrect=no withbackgroundmodel=yes withsrc=yes srclabel=USER srcstyle=radec srcra=339.015 srcdec=33.9758667 xpsfincl=98

cp *R1*EVENLI*FIT r1_evt1.fits
cp *R2*EVENLI*FIT r2_evt1.fits

cp *R1*SRCLI*FIT r1_src.fits
cp *R2*SRCLI*FIT r2_src.fits

cp *R1*EXPMAP*.FIT r1_exp.fits
cp *R2*EXPMAP*.FIT r2_exp.fits

#create an image
evselect table='r1_evt1.fits:EVENTS' imageset='my_pi.fit' xcolumn='M_LAMBDA' ycolumn='PI' yimagemin=0 yimagemax=3000 expression='REGION(r1_src.fits:RGS1_SRC3_SPATIAL,M_LAMBDA,XDSP_CORR)'
rgsimplot endispset='my_pi.fit' spatialset='my_spatial.fit' srcidlist='3' srclistset='r1_src.fits' device=/CPS plotfile=rgs1.ps

#create light curve
evselect table=r1_evt1.fits:EVENTS withrateset=yes rateset=ltcrv.fits maketimecolumn=yes timebinsize=100 makeratecolumn=yes expression='(CCDNR==9)&&(REGION(r1_src.fits:RGS1_BACKGROUND,M_LAMBDA,XDSP_CORR))'

#create gti file
tabgtigen table=ltcrv.fits gtiset=gti.fits expression='(RATE<0.1)'

#rerun the pipeline
rgsproc orders='1' withmlambdacolumn=yes spectrumbinning=lambda bkgcorrect=no withbackgroundmodel=yes withsrc=yes srclabel=USER srcstyle=radec srcra=339.015 srcdec=33.9758667 xpsfincl=98 auxgtitables=gti.fits


#combine spectra
rgscombine pha='P0021140201R1S004SRSPEC1003.FIT P0021140201R2S005SRSPEC1003.FIT' rmf='P0021140201R1S004RSPMAT1003.FIT P0021140201R2S005RSPMAT1003.FIT' bkg='P0021140201R1S004MBSPEC1000.FIT P0021140201R2S005MBSPEC1000.FIT' filepha=all_pha.fits filermf=all_rmf.fits filebkg=all_mbg.fits min=6 max=38

```

